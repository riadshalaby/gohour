We are building a Go CLI application named `gohour`.

Last update date:
- 2026-02-22

Current baseline:
- Existing app uses Cobra + Viper.
- Import pipeline supports Excel/CSV -> normalized worklogs -> SQLite.
- Reconcile step (`gohour reconcile`) exists and adjusts overlaps by moving only EPM entries.
- Export supports raw (`csv`/`excel`) and daily summary mode.

Configuration model (already in place):
- `user`
- `url`
- `port`
- `auto_reconcile_after_import`
- `epm.rules[]`:
  - `name`
  - `file_template`
  - `project`
  - `activity`
  - `skill`

CLI config commands (already in place):
- `gohour config create`
- `gohour config show`
- `gohour config edit`
- `gohour config delete`

REST discovery result (OnePoint):
- Correct target host for worklog operations:
  - `https://onepoint.virtual7.io/onepoint/faces/home`
- Discovered lookup endpoints (all POST with empty body):
  - `/OPServices/resources/OpProjects/getAllUserProjects?mode=all`
  - `/OPServices/resources/OpProjects/getAllUserActivities?mode=all`
  - `/OPServices/resources/OpProjects/getAllUserSkills?mode=all`
- Discovered worklog read endpoint:
  - `GET /OPServices/resources/OpWorklogs/{DD-MM-YYYY}:{DD-MM-YYYY}/getFilteredWorklogs`
- Discovered worklog persist endpoint:
  - `POST /OPServices/resources/OpWorklogs/{DD-MM-YYYY}/persistWorklogs`
- Required/auth-related behavior from captured traffic:
  - Session cookie auth via `JSESSIONID` + `_WL_AUTHCOOKIE_JSESSIONID`
  - `X-Requested-With: XMLHttpRequest`
  - JSON body for persist
  - Date path format is `DD-MM-YYYY`
  - Time values are minutes from midnight (for example `540` = 09:00)

Observed payload/response contract:
- Persist request payload is an array of worklog objects containing:
  - `timerecordId`, `workslipId`, `workrecordId`
  - `worklogDate`
  - `startTime`, `finishTime`, `duration`, `billable`, `valuable`
  - `projectId`, `activityId`, `skillId`
  - `comment`
- Persist success response is an array with entries containing:
  - `message`, `messageType`
  - `newTimeRecordId`, `oldTimeRecordId`
  - `workRecordId`, `workSlipId`
  - `worklogDate` (ISO timestamp in response)
- `getFilteredWorklogs` response shape:
  - `{ "worklogs": [ ... ] }`
  - each worklog includes `projectId`, `activityId`, `skillId`, ids, times, comment, etc.

Implemented in code this session:
- New package `onepoint` added:
  - `onepoint/client.go`
  - `onepoint/client_test.go`
- New reusable API interface:
  - `type Client` with:
    - `ListProjects`
    - `ListActivities`
    - `ListSkills`
    - `GetFilteredWorklogs`
    - `GetDayWorklogs`
    - `PersistWorklogs`
    - `FetchLookupSnapshot`
    - `ResolveIDs`
- HTTP client implementation:
  - `NewClient(ClientConfig{...})`
  - request header handling (`Accept`, `X-Requested-With`, `Referer`, `Cookie`, optional `User-Agent`)
  - non-2xx error body propagation
- Added OnePoint model types:
  - `Project`, `Activity`, `Skill`, `DayWorklog`, `PersistWorklog`, `PersistResult`
- Added `FlexibleInt64` type for fields that can be numeric IDs or empty strings in JSON.
- Added deterministic ID resolution:
  - `ResolveIDsFromSnapshot(snapshot, projectName, activityName, skillName, options)`
  - strict chain:
    - project name -> project ID
    - within project: activity name -> activity ID
    - within activity: skill name -> skill ID
  - explicit errors for not found / archived-only / locked-only / ambiguous matches
- Added date helpers:
  - `FormatDay` and `ParseDay` with `DD-MM-YYYY`.

Tests added and verified:
- Endpoint/path/header tests for lookup/get/persist flow.
- Resolver behavior tests (success, archived filtering, ambiguity).
- `FlexibleInt64` marshal/unmarshal tests.
- Full test run passes with:
  - `GOCACHE=/tmp/gocache go test ./...`

Important known constraints:
- In this sandbox, default Go cache path may fail due permissions; use:
  - `GOCACHE=/tmp/gocache go test ./...`
- Playwright artifacts and traces can contain sensitive session data.

Open TODOs (next implementation steps):
- Integrate `onepoint` package into CLI command(s), likely a new submit workflow.
- Implement submit orchestration:
  - read day worklogs (`GET`)
  - merge imported/local entries into day state
  - persist (`POST`)
  - verify by re-reading day state
- Add error-contract handling for persist failures (validation/auth expiry), not yet captured from production responses.
- Decide and document behavior for placeholder rows (`timerecordId < 0`) in persist payload.

Language requirement:
- All user-facing text, logs, command descriptions, comments, and documentation must remain in English.
